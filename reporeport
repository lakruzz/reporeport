#!/usr/bin/env python3
import os
import subprocess
import json
import sys
import base64
import re

# Add the subdirectory containing the classes to the general class_path
class_path = os.path.dirname(os.path.abspath(__file__))+"/classes"
sys.path.append(class_path)

from repo import Repo
from ghutils import Ghutils

# Try to import the argparse module
try:
    import argparse
except ImportError:
    # If the module is not found, install it
    print("argparse module not found. Installing...")
    subprocess.check_call(["pip", "install", "argparse"])
    # Try to import the module again
    importlib.import_module("argparse")

if __name__ == "__main__":

    # Define command-line arguments
    parser = argparse.ArgumentParser()
    

    
    exclusive_group = parser.add_mutually_exclusive_group(required=True)
    exclusive_group.add_argument(
        '--file', help='A file containing a list of full names (user/repo) of repositories')
    exclusive_group.add_argument('--fullname', help='The full name of the repository in the form "org/repo"')
    exclusive_group.add_argument('--to-issue', action='store_true', help='Indicates that the report is generated from current dir and should be printed to an issue.')
    
    args = parser.parse_args()

    # --file
    if args.file is not None:
        # Read the list of repositories from the specified file
        with open(args.file, 'r') as f:
            repos = [line.strip() for line in f]

        # Extract the organization and repository name from each line in the file and print the report
        for repo in repos:
            org, repo_name = repo.split('/', maxsplit=1)
            Repo.full_report(org, repo_name)
   
    # --fullname
    elif args.fullname is not None:
        org, repo_name = args.fullname.split('/', maxsplit=1)
        Repo.full_report(org, repo_name)

    # --to-issue
    elif args.to_issue:
        fullname = Ghutils.get_org_repo_from_current_directory()
        if fullname is None:
            print("Unable to determine the repository name from the current directory. Are you in a repository?", file=sys.stderr)
            sys.exit(1)
        org, repo_name = fullname.split('/', maxsplit=1)
        Repo.full_report(org, repo_name) 

    # Arguments used incorrectly
    else:
        print("""
Usage:
  reporeport {--org <org> --repo <repo> | --fullname <org/repo> | --file <file>}| --to-issue]

Where:
  --org <org>       The GitHub organization or user
  --repo <repo>     The name of the repository
  --fullname <org/repo>  The full name of the repository in the form "org/repo"
  --file <file>     A file containing a list of full names (user/repo) of repositories
  """, file=sys.stderr)
        sys.exit(1)
